<?php
include 'connect.php';

$resultTable=null;
?>


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- CSS only -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <link href="Bootstrap/css/bootstrap.min.css">
    <script src="Bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <!-- JavaScript Bundle with Popper -->

    <script>
        $(document).ready(function(){
            $("#filterSelect").click(function(){
                alert("H");
            });

            $("#filterBtn").click(function(){
                
                var firm1 = 0,firm2 = 0,firm3 = 0;

                if($("#firm1").prop("checked")){
                    firm1 = $("#firm1").val();
                }
                if($("#firm2").prop("checked")){
                    firm2 = $("#firm2").val();
                }
                if($("#firm3").prop("checked")){
                    firm3 = $("#firm3").val();
                }

                var clientId = $('#cityname option').filter(function() {
                    return this.value == $("#clientName").val();
                }).data('id');
                
                $.ajax({
                    url: 'filterReceivables.php', // your php file
                    type: 'POST', // type of the HTTP request
                    data: { "firm1": firm1,"firm2": firm2, "firm3": firm3, "clientId": clientId},
                    success: function(result) {
                        if(result){
                            obj = JSON.parse(result);
                            $("#firmName").val(obj[0]['shortname']);
                            $(document).cookie="objCookie="+JSON.stringify(obj);
                        }

                    }
                });
            });
        });
    </script>
    <title>Receivables</title>
</head>

<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center">Receivables</h1>
        <a class="text-center pl-5 ml-5" id="filterSelect">Filter</a>
        <div id="filter" class="border border-2 p-5 m-5">
                <div class="row col-12 form-group">
                    <h5 class="col-2">Select Firm:</h5>
                    <div class="form-check col-2 form-check-inline">
                        <input class="form-check-input" type="checkbox" id="firm3" name="firm3" value="3">
                        <label class="form-check-label" for="firm1">H Mistry & Associates</label>
                    </div>
                    <div class="form-check col-2 form-check-inline">
                        <input class="form-check-input" type="checkbox" id="firm1" name="firm1" value="1">
                        <label class="form-check-label" for="firm2">Jinal Waghela & Associates</label>
                    </div>
                    <div class="form-check col-2 form-check-inline">
                        <input class="form-check-input" type="checkbox" id="firm2" name="firm2" value="2">
                        <label class="form-check-label" for="firm3">MoneySphere Solutions</label>
                    </div>
                </div>
                <br>
                <div class="row col-12">
                    <h5 class="col-2">Select client:</h5>
                    <div class="col-4">
                    <input type="text" id="clientName" name="clientName" class="form-control" aria-label="Default select example"
                        list="cityname" value="All Clients">

                    <datalist id="cityname">
                        <option data-id="0" selected >All Clients</option>
                        <?php
                $sql="select * from clientlist order by clientName";
                $result=mysqli_query($con,$sql) or die($con->error);   
                if($result->num_rows>0){
                    while($row=$result->fetch_assoc()){
                    
                ?>
                        <option data-id="<?php echo $row['clientId']; ?>">
                            <?php echo $row['clientName']; ?>
                        </option>
                        <?php 
                    }
                }
                ?>
                    </datalist>
                    </div>
                </div>
                <button id="filterBtn" class="btn btn-success col-auto mt-3">Filter</button>
        </div>
        <table id="tbl" class="table table-responsive-md table-responsive-sm table-striped table-bordered mt-5" width="100%">
            <thead style="background-color: rgb(79,129,189);">
                <tr style="color:white;">
                    <th>Sr. No.</th>
                    <th>Firm Name</th>
                    <th>Bill No.</th>
                    <th>Date</th>
                    <th>Party</th>
                    <th>Amount</th>
                    <th>Amount Received</th>
                    <th>Receipt Date</th>
                    <th>Mode</th>
                    <th>Chq. No.</th>
                    <th>Amount Pending</th>
                    <th>TDS</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <?php
                $query = "select * from bill_master bm inner join clientlist cl inner join firmname fn on bm.firm_id = fn.firmNameId and bm.client_id = cl.clientId";
                $resultTable = mysqli_query($con, $query);
                if ($resultTable->num_rows > 0) {
                    $row_count = 0;
                    while ($row = mysqli_fetch_assoc($result)) {
                        $row_count += 1;
                ?>
                <tr>
                    <td class="text-center">
                        <?php echo $row_count; ?>
                    </td>
                    <td class="text-left" >
                        <?php echo $row['shortform']; ?>
                    </td>
                    <td class="text-left">
                        <?php echo $row['invoice_no']; ?>
                    </td>
                    <td class="text-right">
                        <?php echo $row['invoice_date']; ?>
                    </td>
                    <td class="text-left">
                        <?php echo $row['clientName']; ?>
                    </td>
                    <td class="text-right">
                        <?php echo $row['total_amount']; ?>
                    </td>
                    <td>
                        <div style="width:60%;">
                            <?php
                                    if ($row['amount_received'] == 0) {
                                    ?>
                            <select id="<?php echo $row_count. 'amount_received'; ?>" class="custom-select" disabled>
                                <option value="0" class="text-danger" selected >No</option>
                                <option value="1" class="text-success">Yes</option>
                            </select>
                            <?php
                                    } else {
                                    ?>
                            <span class="text-success">Yes</span>
                            <?php
                                    }
                                    ?>
                        </div>
                    </td>
                    <td class="text-right"><input type="date" class="form-control" id="<?php echo $row_count . 'rDate'; ?>"
                            value="<?php echo $row['receipt_date']; ?>" disabled></td>
                    <td class="text-left">
                        <select class="form-control" id="<?php echo $row_count.'mode' ?>" disabled>
                            <option value="online" selected>Online</option>
                            <option value="cheque">Cheque</option>
                            <option value="cash">Cash</option>
                        </select>
                    </td>
                    <td class="text-left col-1" ><input type="text" class="form-control" id="<?php echo $row_count . 'chq'; ?>"
                            value="<?php echo $row['cheque_no']; ?>" disabled></td>
                    <td class="text-right col-1"><input type="text" class="form-control" id="<?php echo $row_count . 'pending'; ?>"
                            value="<?php echo $row['amount_pending']; ?>" disabled></td>
                    <td class="text-left col-1"><input type="text" class="form-control" id="<?php echo $row_count . 'tds'; ?>"
                            value="<?php echo $row['tds']; ?>" disabled></td>
                    <td width="10%">
                        <div class="row col-12" width="100%" style="display:inline-block;">
                            <button class="btn btn-primary col-5 mr-1" style="float:left;" id="<?php echo $row_count . 'edit' ?>"
                                onClick="handleEdit('<?php echo $row_count; ?>','Edit', '<?php echo $row['firm_id']; ?>', '<?php echo $row['invoice_no']; ?>')" class="btn btn-primary mb-2">
                                &#10000;
                            </button>
                            <button class="btn btn-primary text-center col-5 mr-1" style="float:left; display:none;" id="<?php echo $row_count . 'save' ?>"
                                onClick="handleEdit('<?php echo $row_count; ?>','Save', '<?php echo $row['firm_id']; ?>', '<?php echo $row['invoice_no']; ?>')" class="btn btn-success m-2">
                                &#10004;
                            </button>
                            <button class="btn btn-danger text-center col-5" style="float:right;" id="<?php echo $row_count; ?>"
                                onClick="handleCancel('<?php echo $row_count; ?>')" class="btn btn-danger mt-2">
                                &#10008;
                            </button>
                        </div>
                    </td>
                </tr>

                <?php
                    }
                }
                ?>
            </tbody>
        </table>
    </div>


    <script>
        function handleEdit(id, action,firmId,invoice_no) {
            if (action == 'Edit') {
                if ($('#' + id + 'amount_received').val() == 0) {
                    document.getElementById(id + 'edit').style.display = 'none';
                    document.getElementById(id + 'save').style.display = 'block';
                    $("#" + id + 'amount_received').prop('disabled', false);
                    $("#" + id + 'rDate').prop('disabled', false);
                    $("#" + id + 'mode').prop('disabled', false);
                    $("#" + id + 'chq').prop('disabled', false);
                    $("#" + id + 'pending').prop('disabled', false);
                    $("#" + id + 'tds').prop('disabled', false);
                } else {
                    alert("Payment Done..Cannot Edit");
                }


            } else {
                handleCancel(id);
                $.ajax({
                    type: "POST",
                    url: "updateReceivables.php",
                    data: {
                        "firmId":firmId,
                        "invoice_no":invoice_no
                    },
                    success: function (data) {
                        alert(data);
                        location.reload();
                    }
                });
            }

        }

        function handleCancel(id) {
            document.getElementById(id + 'edit').style.display = 'block';
            document.getElementById(id + 'save').style.display = 'none';
            $("#" + id + 'amount_received').prop('disabled', true);
            $("#" + id + 'rDate').prop('disabled', true);
            $("#" + id + 'mode').prop('disabled', true);
            $("#" + id + 'chq').prop('disabled', true);
            $("#" + id + 'pending').prop('disabled', true);
            $("#" + id + 'tds').prop('disabled', true);


            document.cookie = "amount_received=" + $("#"+id+"amount_received").val();
            document.cookie = "receipt_date="+ $("#"+id+"rDate").val();
            document.cookie = "pay_mode=" + $("#" + id + 'mode').val();
            document.cookie = "chq=" + $("#" + id + 'chq').val();
            document.cookie = "pending=" + $("#" + id + 'pending').val();
            document.cookie = "tds=" + $("#" + id + 'tds').val();

        }
    </script>

</body>

</html>